# frozen_string_literal: true

# Creates the `<%= @singular_table_name %>_versions` table
class Create<%= @model %> < ActiveRecord::Migration[<%= ActiveRecord::Migration.current_version %>]
  def change
    create_table :storage_tables_<%= @singular_table_name %>_attachments, primary_key: [:record_id, :checksum, :blob_key] do |t|
      t.string :blob_key, null: false, limit: 1
      t.string :name,         null: false
      t.string     :filename, null: false
      t.belongs_to :record,   null: false, foreign_key: { to_table: :<%= @table_name %> }
      t.string :checksum, null: false, foreign_key: false
      t.datetime :created_at, null: false
    end

    ActiveRecord::Base.connection.execute <<~SQL.squish
      ALTER TABLE storage_tables_<%= @singular_table_name %>_attachments
      ADD CONSTRAINT storage_tables_<%= @singular_table_name %>_attachments_blob_fkey
      FOREIGN KEY (checksum, blob_key)
      REFERENCES storage_tables_blobs (checksum, partition_key);
    SQL

    ActiveRecord::Base.connection.execute <<~SQL.squish
      CREATE TRIGGER storage_tables_<%= @singular_table_name %>_attachments_created AFTER INSERT ON storage_tables_<%= @singular_table_name %> FOR EACH ROW EXECUTE FUNCTION increment_attachment_counter()
    SQL

    ActiveRecord::Base.connection.execute <<~SQL.squish
      CREATE TRIGGER storage_tables_<%= @singular_table_name %>_attachments_deleted AFTER INSERT ON storage_tables_<%= @singular_table_name %> FOR EACH ROW EXECUTE FUNCTION decrement_attachment_counter()
    SQL
  end
end
